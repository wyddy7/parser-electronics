<!-- 5d062481-83db-48df-807b-dcf712fbf777 a9fb06a3-2876-4c93-9c2b-4068aba6e536 -->
# План исправления парсеров (упрощенный)

## Критические проблемы

1. **Паттерн извлечения артикула не поддерживает пробелы**: `"Fluke T90"` → извлекается только `"Fluke"`
2. **Проверка модификации слишком строгая**: `"T90,"` не совпадает с `"T90"` и блокирует правильные совпадения
3. **Нет обрезки после запятой**: все парсеры отправляют полные запросы с описаниями

## Решения (минимальные изменения)

### 1. Улучшить извлечение артикула в `_is_name_match`

**Файл**: `src/parsers/base_async_parser.py`

**Изменения**:

- Улучшить существующий `spaced_pattern` для поддержки пробела перед дефисом/слэшем
- Добавить специальную обработку для Fluke: `"Fluke T90"` → `"FlukeT90"` (убрать пробел)
- Нормализовать пробелы при сравнении (уже делается)

**Код**:

```python
# Для Fluke: специальная обработка перед основным паттерном
if original_text.startswith('Fluke'):
    fluke_match = re.match(r'(Fluke\s+[A-Za-z0-9+/\-]+)', original_text, re.IGNORECASE)
    if fluke_match:
        original_code = fluke_match.group(1).replace(' ', '')  # "Fluke T90" → "FlukeT90"
    else:
        original_code = original_text.split()[0]  # Fallback
else:
    # Существующая логика с улучшенным spaced_pattern
    spaced_pattern = re.compile(r'^([А-ЯA-ZЁ]+(?:\s+[A-Za-z0-9]+)?[-/][0-9]+(?:[/][0-9]+)?)', re.IGNORECASE)
    # ... остальная логика
```

### 2. Улучшить проверку модификации

**Файл**: `src/parsers/base_async_parser.py`

**Изменения**:

- Убрать запятую из модификации: `modification = original_words[1].lower().rstrip(',')`
- Не проверять модификацию, если она короткая (1-3 символа) и является частью артикула

**Код**:

```python
if len(original_words) > 1:
    modification = original_words[1].lower().rstrip(',')  # Убираем запятую
    
    # Если модификация короткая и является частью артикула - пропускаем проверку
    if len(modification) <= 3 and modification.isalnum():
        found_code_normalized = found_code.lower().replace(' ', '').replace('-', '')
        if modification in found_code_normalized:
            return True  # Это часть артикула, не модификация
    
    # Проверяем наличие модификации в найденном названии
    found_name_lower = found.lower().replace(',', '')
    if modification not in found_name_lower:
        return False
```

### 3. Добавить обрезку после запятой в базовую нормализацию

**Файл**: `src/parsers/base_async_parser.py`

**Изменения**:

- Обрезать после запятой (если есть)
- Убрать лишние пробелы
- **НЕ ограничивать количество слов** (это может сломать артикулы)

**Код**:

```python
def _normalize_search_query(self, product_name: str) -> str:
    # Обрезаем после запятой
    if ',' in product_name:
        product_name = product_name.split(',')[0].strip()
    
    # Убираем лишние пробелы
    return ' '.join(product_name.split())
```

### 4. Обновить парсеры (минимальные изменения)

**Файлы для изменения**:

- `chipdip_async_parser.py`: Убрать метод `_normalize_search_query` (использовать базовый)
- `keysight_technologies_async_parser.py`: Убрать метод `_normalize_search_query` (использовать базовый)
- `mprofit_async_parser.py`: Убрать метод `_normalize_search_query` (использовать базовый)
- `zenit_electro_async_parser.py`: Вызвать `super()._normalize_search_query()` перед заменой пробелов на `+`
- `pribor_x_async_parser.py`: Вызвать `super()._normalize_search_query()` перед заменой пробелов на `+`
- `electronpribor_async_parser.py`: Вызвать `super()._normalize_search_query()` перед заменой пробелов на `+`
- `prist_async_parser.py`: Оставить как есть (уже правильно)
- `flukeshop_async_parser.py`: Оставить как есть (уже правильно)

## Порядок реализации

1. Исправить `_is_name_match` (извлечение артикула + проверка модификации)
2. Исправить `_normalize_search_query` (обрезка после запятой)
3. Обновить парсеры (убрать/дополнить нормализацию)

## Что НЕ делать

- ❌ НЕ ограничивать количество слов в нормализации (может сломать артикулы)
- ❌ НЕ создавать сложные паттерны (использовать существующие, улучшить их)
- ❌ НЕ менять логику парсеров, которая уже работает

### To-dos

- [ ] Исправить паттерн извлечения артикула в _is_name_match для поддержки пробелов (Fluke T90, АКИП 9806/3)
- [ ] Улучшить проверку модификации: убрать запятые, не считать часть артикула модификацией, более гибкая проверка
- [ ] Добавить универсальную нормализацию запросов в базовый класс: обрезка после запятой, оставлять только артикул (первые 2-3 слова)
- [ ] Обновить chipdip_async_parser.py: использовать базовую нормализацию или дополнить её
- [ ] Обновить keysight_technologies_async_parser.py: использовать базовую нормализацию или дополнить её
- [ ] Обновить mprofit_async_parser.py: использовать базовую нормализацию или дополнить её
- [ ] Обновить zenit_electro_async_parser.py: дополнить базовую нормализацию заменой пробелов на +
- [ ] Обновить pribor_x_async_parser.py: дополнить базовую нормализацию заменой пробелов на +
- [ ] Обновить electronpribor_async_parser.py: дополнить базовую нормализацию заменой пробелов на +